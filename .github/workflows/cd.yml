name: CD - 持续部署

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy-staging:
    name: 部署到Staging环境
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging-api.yourdomain.com
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 配置kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
    
    - name: 部署到Kubernetes
      run: |
        # 更新镜像
        kubectl set image deployment/short-drama-app \
          app=${{ secrets.DOCKER_REGISTRY }}/short-drama-app:main-${{ github.sha }} \
          -n short-drama-staging
        
        # 等待部署完成
        kubectl rollout status deployment/short-drama-app -n short-drama-staging --timeout=5m
    
    - name: 运行数据库迁移
      run: |
        kubectl exec -n short-drama-staging \
          deployment/short-drama-app -- \
          alembic upgrade head
    
    - name: 运行烟雾测试
      run: |
        curl -f https://staging-api.yourdomain.com/health || exit 1
        curl -f https://staging-api.yourdomain.com/api/docs || exit 1
    
    - name: 通知部署成功
      if: success()
      run: echo "Staging部署成功"
    
    - name: 回滚部署
      if: failure()
      run: |
        kubectl rollout undo deployment/short-drama-app -n short-drama-staging

  deploy-production:
    name: 部署到Production环境
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://api.yourdomain.com
    needs: []
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 提取版本号
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=main-${{ github.sha }}" >> $GITHUB_OUTPUT
        fi
    
    - name: 配置kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}
    
    - name: 创建备份
      run: |
        # 备份当前部署
        kubectl get deployment short-drama-app -n short-drama-prod -o yaml > deployment-backup.yaml
        
        # 备份数据库
        kubectl exec -n short-drama-prod deployment/postgres -- \
          pg_dump -U postgres short_drama_prod > db-backup.sql
    
    - name: 部署到Kubernetes
      run: |
        # 更新镜像
        kubectl set image deployment/short-drama-app \
          app=${{ secrets.DOCKER_REGISTRY }}/short-drama-app:${{ steps.version.outputs.version }} \
          -n short-drama-prod
        
        # 等待部署完成
        kubectl rollout status deployment/short-drama-app -n short-drama-prod --timeout=10m
    
    - name: 运行数据库迁移
      run: |
        kubectl exec -n short-drama-prod \
          deployment/short-drama-app -- \
          alembic upgrade head
    
    - name: 运行健康检查
      run: |
        # 等待服务稳定
        sleep 30
        
        # 健康检查
        curl -f https://api.yourdomain.com/health || exit 1
        
        # API检查
        curl -f https://api.yourdomain.com/api/docs || exit 1
        
        # 监控指标检查
        curl -f https://api.yourdomain.com/metrics || exit 1
    
    - name: 运行E2E测试
      run: |
        # 运行生产环境的E2E测试
        echo "运行E2E测试..."
        # 这里可以添加实际的E2E测试命令
    
    - name: 通知部署成功
      if: success()
      run: |
        echo "Production部署成功: ${{ steps.version.outputs.version }}"
        # 这里可以添加Slack/Email通知
    
    - name: 回滚部署
      if: failure()
      run: |
        echo "部署失败，开始回滚..."
        kubectl rollout undo deployment/short-drama-app -n short-drama-prod
        
        # 恢复数据库（如果需要）
        # kubectl exec -n short-drama-prod deployment/postgres -- \
        #   psql -U postgres short_drama_prod < db-backup.sql
    
    - name: 上传备份文件
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: deployment-backup
        path: |
          deployment-backup.yaml
          db-backup.sql
        retention-days: 30

  post-deploy:
    name: 部署后任务
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: success()
    
    steps:
    - name: 清理旧镜像
      run: |
        echo "清理旧的Docker镜像..."
        # 这里可以添加清理逻辑
    
    - name: 更新文档
      run: |
        echo "更新部署文档..."
        # 这里可以添加文档更新逻辑
    
    - name: 发送通知
      run: |
        echo "发送部署通知..."
        # 这里可以添加通知逻辑（Slack, Email等）
