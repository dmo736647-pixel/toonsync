# Prometheus告警规则
groups:
  - name: short_drama_alerts
    interval: 30s
    rules:
      # API错误率告警
      - alert: HighAPIErrorRate
        expr: |
          (
            rate(api_errors_total[5m]) / 
            rate(api_requests_total[5m])
          ) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "API错误率过高"
          description: "API错误率超过5%，当前值：{{ $value | humanizePercentage }}"

      - alert: CriticalAPIErrorRate
        expr: |
          (
            rate(api_errors_total[5m]) / 
            rate(api_requests_total[5m])
          ) > 0.10
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API错误率严重过高"
          description: "API错误率超过10%，当前值：{{ $value | humanizePercentage }}"

      # API响应时间告警
      - alert: SlowAPIResponse
        expr: |
          histogram_quantile(0.95, 
            rate(api_response_time_seconds_bucket[5m])
          ) > 5
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "API响应时间过慢"
          description: "API P95响应时间超过5秒，当前值：{{ $value }}秒"

      - alert: VerySlowAPIResponse
        expr: |
          histogram_quantile(0.95, 
            rate(api_response_time_seconds_bucket[5m])
          ) > 10
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API响应时间严重过慢"
          description: "API P95响应时间超过10秒，当前值：{{ $value }}秒"

      # AI模型告警
      - alert: AIModelLowSuccessRate
        expr: |
          (
            rate(ai_model_errors_total[5m]) / 
            rate(ai_model_requests_total[5m])
          ) > 0.10
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "AI模型成功率低"
          description: "AI模型成功率低于90%，当前错误率：{{ $value | humanizePercentage }}"

      - alert: AIModelProcessingSlow
        expr: |
          histogram_quantile(0.95, 
            rate(ai_model_processing_time_seconds_bucket[5m])
          ) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "AI模型处理速度慢"
          description: "AI模型P95处理时间超过30秒，当前值：{{ $value }}秒"

      # 数据库告警
      - alert: HighDatabaseConnections
        expr: db_connections_active > 50
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "数据库连接数过高"
          description: "活跃数据库连接数超过50，当前值：{{ $value }}"

      - alert: SlowDatabaseQuery
        expr: |
          histogram_quantile(0.95, 
            rate(db_query_duration_seconds_bucket[5m])
          ) > 2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "数据库查询速度慢"
          description: "数据库P95查询时间超过2秒，当前值：{{ $value }}秒"

      # 缓存告警
      - alert: LowCacheHitRate
        expr: |
          (
            rate(cache_hits_total[5m]) / 
            (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m]))
          ) < 0.50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "缓存命中率低"
          description: "缓存命中率低于50%，当前值：{{ $value | humanizePercentage }}"

      # 速率限制告警
      - alert: HighRateLimitExceeded
        expr: rate(rate_limit_exceeded_total[5m]) > 10
        for: 2m
        labels:
          severity: info
        annotations:
          summary: "速率限制频繁触发"
          description: "速率限制每分钟触发超过10次，当前值：{{ $value }}"

      # 系统资源告警
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes / 
            node_memory_MemTotal_bytes
          ) > 0.80
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过80%，当前值：{{ $value | humanizePercentage }}"

      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total[5m]) > 0.80
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "CPU使用率超过80%，当前值：{{ $value | humanizePercentage }}"
